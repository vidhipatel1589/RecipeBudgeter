<!DOCTYPE html>
<html lang="en">
<head>
    <title>Recipe Budgeter</title>
    <link rel="stylesheet" href="style.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css'
          rel='stylesheet'>
</head>
<body>
    <div class="wrapper">
        <h1 class="Title">Recipe Budgeter</h1>
        <form id="loginForm">
            <h1>Login</h1>
            <div class="input-box">
                <input type="text" id="username" placeholder="Username/Email"
                       required>
                <i class='bx bxs-user'></i>
            </div>

            <div class="input-box">
                <input type="password" id="password"
                       placeholder="Password" required>
                <i class='bx bxs-lock-alt'></i>
            </div>

            <button type="submit" class="login-button">Login</button>

            <div class="register">
                <a href="#" onclick="showSignup()">Create Account</a>
            </div>
        </form>
    </div>

    <div class="wrapper" id="signupWrapper" style="display: none;"> 
        <form id="signupForm">
            <h1 class="Title">Recipe Budgeter</h1>
            <h1 class="Subtitle">Sign Up</h1>

            <div class="input-box">
                <input type="text" id="name" placeholder="Name" required>
                <i class='bx bxs-envelope'></i>
            </div>  

            <div class="input-box">
                <input type="text" id="newUsername" placeholder="Username" required>
                <i class='bx bxs-user'></i>
            </div> 

            <div class="input-box">
                <input type="password" id="newPassword" placeholder="Password" required>
                <i class="bx bxs-lock-alt"></i>
            </div>

            <div class="input-box">
                <input type="password" id="confirmpassword" placeholder="Confirm Password" required>
                <i class='bx bxs-lock-alt'></i>
            </div>     
            
            <button type="submit" class="login-button">Sign Up</button>

            <div class="register">
                <a href="#" onclick="showLogin()">Already have an account? Login</a>
            </div>    
        </form>
    </div>

    <!-- navigation bar -->
    <nav class="navbar" id="navbar" style="display: none;">
        <ul>
            <li><a href="#home">Home</a></li>
            <li><a href="#add-recipe">Add A New Recipe</a></li>
            <li><a href="#view-recipes">Update A Recipe</a></li>
            <li><a href="#" onclick="showLogin()">Logout</a></li>
        </ul>
    </nav>

    <!------------------------------------------------------------------------------------------->
    <!-- for home page -->
    <div class="section" id="home" style="display: none;">
        <h2>Welcome to Recipe Budgeter</h2>
        <h1>Here are your recipes!</h1>
        <h3 style="text-align: center;">Click on a recipe to view details</h3>

        <!--recipe list-->
        <div id="recipeList">
            <!-- Populated with JS -->
        </div>


        <!--recipe cost details for home page -->
        <div id="recipeCostDetailsHome" style="display: none;">
            <h4 id="chosenRecipeNameHome"></h4>
            <div class="description-box">
                <textarea readonly id="recipeDescriptionBox" placeholder="Recipe Description" required></textarea>
            </div> 
            <table>
                <thead>
                    <tr>
                        <th>Ingredient</th>
                        <th>Quantity</th>
                        <th>Unit</th>
                        <th>Price</th>
                        <th>Availability</th>
                    </tr>
                </thead>
                <tbody id="ingredientCostListHome">

                </tbody>
            </table>
            <h5>Total Cost: <span id="totalCostHome"></span></h5>
        </div>

    </div>

    <!------------------------------------------------------------------------------------------->
    <!-- for add new recipe page -->
    <div class="section" id="add-recipe" style="display: none;">
        <h2>Add Your Recipe</h2>
        <h3 style="text-align: center;">Add your own recipe</h3>
        <form action="" class="add-recipe-entry">
            <div class="input-box">
                <input type="text" placeholder="Recipe Name" required>
            </div>
            <div class="description-box">
                <textarea placeholder="Recipe Description" required></textarea>
            </div>    
            <div class="ingredients-list" id="ingredients-list">
                 
            </div>

            <button type="button" id="addRowButton">Add Another Ingredient</button>
            <button type="button" onclick="saveNewRecipe()">Save Recipe</button>
        </form>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const quantityInputs = document.querySelectorAll('.initialQuantity');
            quantityInputs.forEach(input => {
                input.addEventListener('input', () => {
                    if (input.value < 0) {
                        input.value = 0;
                    }
                });
            });
        });

        function getItemsWithUnits() {
            //console.log('fetching items with units');
            return fetch('http://localhost:1337/api-v2/getAllItems')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP Error: ' + response.status);
                    }
                    return response.json(); // Return the parsed JSON data
                })
                .then(data => {
                    return data; // Return the data to the caller
                })
                .catch(error => {
                    console.error('Error fetching items with units:', error);
                    throw error; // Re-throw the error to be handled upstream
                });
        }

        // Populate all ingredient dropdowns
        function populateAddItemDropdown() {
            getItemsWithUnits()
                .then(itemsWithUnits => {
                    //console.log('Items with units:', itemsWithUnits);
                
                    const dropdowns = document.querySelectorAll('.ingredientDropdown'); // Select all elements with class ingredientDropdown

                    dropdowns.forEach(dropdown => {
                        dropdown.innerHTML = '<option value="">Select Ingredient</option>'; // Reset options

                        for (item of itemsWithUnits) {
                            const option = document.createElement('option');
                            option.value = item.itemID; // Set value as the item's ID
                            option.textContent = item.itemName; // Set text as the item's name
                            option.setAttribute('data-unit-type', item.unitType); // Set data attribute for unit type
                            dropdown.appendChild(option);
                        }
                    });
                })
                .catch(error => {
                    console.error('Failed to fetch items with units:', error);
                });
        
            
        }

        

        function populateAddUnitDropdown() {
            const conversions = JSON.parse(localStorage.getItem('conversions')) || {};
            const dropdowns = document.querySelectorAll('.unitDropdown');

            dropdowns.forEach(dropdown => {
                dropdown.innerHTML = '<option value="">Select Units</option>';

                for (const unitName of Object.keys(conversions)) {
                    const option = document.createElement('option');
                    option.value = unitName;
                    option.textContent = unitName;
                    dropdown.appendChild(option);
                }
            });
        }

        function populateAddNewDropdown(dropdown, storageKey) {
            const data = JSON.parse(localStorage.getItem(storageKey)) || {};
            const dropdowns = dropdown instanceof NodeList || Array.isArray(dropdown) ? dropdown : [dropdown];

            dropdowns.forEach(dd => {
                dd.innerHTML = '<option value="">Select ' + (storageKey === 'items' ? 'Ingredient' : 'Units') + '</option>';

                for (const [name, value] of Object.entries(data)) {
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = name;
                    dd.appendChild(option);
                }
            });
        }

        function populateRow(itemsWithUnits, units) {
            const ingredientsList = document.getElementById('ingredients-list');

            const ingredientDiv = document.createElement('div');
            ingredientDiv.className = 'ingredient';

            // Create the new ingredient row
            ingredientDiv.innerHTML = `
                <select class="ingredientDropdown" required>
                    <option value="">Select Ingredient</option>
                    ${itemsWithUnits.map(item => `<option value="${item.itemID}" data-unit-id="${item.unitID}">${item.itemName}</option>`).join('')}
                </select>
                <input type="number" placeholder="Quantity" required min="0" class="initialQuantity">
                <select class="unitDropdown" required>
                    <option value="">Select Units</option>
                </select>
                <button type="button" class="X-button" onclick="deleteIngredient(this)">X</button>
            `;
            ingredientsList.appendChild(ingredientDiv);

            const ingredientDropdown = ingredientDiv.querySelector('.ingredientDropdown');
            const unitDropdown = ingredientDiv.querySelector('.unitDropdown');

            ingredientDropdown.addEventListener('change', () => {
                const selectedOption = ingredientDropdown.options[ingredientDropdown.selectedIndex];
                //console.log('Selected option:', selectedOption);
                const unitID = Number(selectedOption.getAttribute('data-unit-id'));
                //console.log('Selected unit ID:', unitID);
                //console.log('units.units:', units.units);
                const unitType = units.units.find(unit => unit.id === unitID)?.unitType ?? '';
                //console.log('Selected unit type:', unitType);

                unitDropdown.innerHTML = '<option value="">Select Units</option>'; // Reset options
                const filteredUnits = units.units.filter(unit => unit.unitType === unitType);
                filteredUnits.forEach(unit => {
                    const option = document.createElement('option');
                    option.value = unit.unitID;
                    option.textContent = unit.unitName;
                    unitDropdown.appendChild(option);
                });
            });
        }

        

        function getAllUnits() {
            //console.log('fetching all units');
            return fetch('http://localhost:1337/api/getAllUnits')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP Error: ' + response.status);
                    }
                    return response.json(); // Return the parsed JSON data
                })
                .then(data => {
                    return data; // Return the data to the caller
                })
                .catch(error => {
                    console.error('Error fetching units:', error);
                    throw error; // Re-throw the error to be handled upstream
                });
        }

        Promise.all([getItemsWithUnits(), getAllUnits()])
        .then(([itemsWithUnits, units]) => {
            //console.log('Items with units:', itemsWithUnits);
            //console.log('Units:', units);
            populateRow(itemsWithUnits, units);

            document.getElementById('addRowButton').addEventListener('click', () => {
                populateRow(itemsWithUnits, units);
            });

            document.getElementById('update-add-ingredient-button').addEventListener('click', () => {
                addUpdateRow(itemsWithUnits, units);
            });
        })
        .catch(error => {
            console.error('Failed to fetch items with units:', error);
        });

        // populateAddItemDropdown();
        // populateAddUnitDropdown();
    </script>

    <!------------------------------------------------------------------------------------------->
    <!-- for update a recipe page -->

    <div class="section" id="view-recipes" style="display: none;">
        <h2>List of Recipes</h2>
        <h3 style="text-align: center;">Select a recipe</h3>
        <!-- select recipe -->
        <select id="chooseRecipeUpdate" >
            <option value="">Select a recipe</option>
        </select>

        <!-- to allow update recipe -->
        <form id="updateRecipeForm" style="display: none;">
            <h1>
                <input type="text" id="recipe-name" required>
            </h1>
            
            <div class="description-box">
                <textarea id="recipe-description" placeholder="Recipe Description" required></textarea>
            </div>  
            <div class="update-ingredients-list" id="update-ingredients-list">
                    <!-- Ingredient items will be dynamically added here -->
            </div>

            <button type="button" id="update-add-ingredient-button">Add Another Ingredient</button>
            <button type="button" id="save-recipe-button">Save Recipe</button>
            <button type="button" id = "update-delete-recipe-button">Delete Recipe</button>
        </form>
    </div>

    <!------------------------------------------------------------------------------------------->
    <!-- Scripts -->

    <script src="js/login.js"></script>
    <script src="js/home.js"></script>
    <script src="js/updateRecipe.js"></script>
    <script>
        
        function getAllUnits() {
            //console.log('fetching all units');
            return fetch('http://localhost:1337/api/getAllUnits')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP Error: ' + response.status);
                    }
                    return response.json(); // Return the parsed JSON data
                })
                .then(data => {
                    return data; // Return the data to the caller
                })
                .catch(error => {
                    console.error('Error fetching units:', error);
                    throw error; // Re-throw the error to be handled upstream
                });
        }

        function getUnitsByType() {
            //console.log('fetching units');
            return fetch('http://localhost:1337/api/getUnitsByType')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP Error: ' + response.status);
                    }
                    return response.json(); // Return the parsed JSON data
                })
                .then(data => {
                    return data; // Return the data to the caller
                })
                .catch(error => {
                    console.error('Error fetching units:', error);
                    throw error; // Re-throw the error to be handled upstream
                });
        }

        function getUnitsOfType(units, type) {
            if (!units || !type) {
                console.error(`Type "${type}" does not exists in the units object`);
                return [];
            }
            return units.units.filter
        }
    

        function showLogin() {
            document.getElementById('signupWrapper').style.display = 'none';
            document.querySelector('.wrapper').style.display = 'block';
            document.getElementById('navbar').style.display = 'none';
               document.getElementById('username').value = '';
    document.getElementById('password').value = '';
        }

        function showSignup() {
            document.querySelector('.wrapper').style.display = 'none';
            document.getElementById('signupWrapper').style.display = 'block';
        }

        //hide other pages when switching through pages on nav bar
        function showSection(sectionId) {
            const sections = document.querySelectorAll('.section');

            sections.forEach(section => {
                section.style.display = 'none';
            });

            document.getElementById(sectionId).style.display = 'block';
        }

        ////////////////////////////////////////////////////////////////////////////////////////

        let recipes = convertRecipes();

        document.querySelectorAll('.navbar a').forEach(link => {
            link.addEventListener('click', function (event) {
                event.preventDefault();
                const targetSection = this.getAttribute('href').substring(1);
                showSection(targetSection);
            });
        });

        ////////////////////////////////////////////////////////////////////////////////////////

        // HOME PAGE SCRIPTS

        //list of clickable recipes on the home page
        function populateRecipeList() {
            const recipeList = document.getElementById('recipeList');
            
            recipeList.innerHTML = '';

            for (const recipeName in recipes) {
                const recipeItem = document.createElement('div');
                recipeItem.className = 'recipe-item';
                recipeItem.textContent = recipeName;
                recipeItem.onclick = () => showRecipeDetailsOnHome(recipeName);
                recipeList.appendChild(recipeItem);
                
            }
        }
        populateRecipeList();

        // clickable and populates table with recipe details
        function showRecipeDetailsOnHome(chosenRecipeName) {
            const recipeDetailsDiv = document.getElementById('recipeCostDetailsHome');
            const ingredientCostList = document.getElementById('ingredientCostListHome');
            const totalCostElement = document.getElementById('totalCostHome');

            if (chosenRecipeName && recipes[chosenRecipeName]) {
                const recipe = recipes[chosenRecipeName];
                document.getElementById('chosenRecipeNameHome').textContent = recipe.name;
                const recipeDescription = document.getElementById('recipeDescriptionBox');

                ingredientCostList.innerHTML = '';
                recipeDescription.value = recipe.description;

                let totalCost = 0;


                recipe.ingredients.forEach((ingredient, index) => {
                    const inventoryItem = recipe.inventory[index];

                    const row = document.createElement('tr');
                    if (inventoryItem) {
                        const pricePerUnit = parseFloat(inventoryItem.price);
                        const size = parseFloat(inventoryItem.size);
                        const pricePerSize = (pricePerUnit / size).toFixed(2);

                        row.innerHTML = `
                            <td>${ingredient.ingredient}</td>
                            <td>${ingredient.quantity}</td>
                            <td>${ingredient.unit}</td>
                            <td>$${pricePerSize} / ${inventoryItem.unit}</td>
                            <td>${ingredient.available ? "In Stock" : "Out of Stock"}</td>
                        `;
                        
                        totalCost = calTotalCost(chosenRecipeName);
                    } else {
                        row.innerHTML = `
                            <td>${ingredient.ingredient}</td>
                            <td>${ingredient.quantity}</td>
                            <td>${ingredient.unit}</td>
                            <td>Price Not Found</td>
                            <td>${ingredient.available ? "In Stock" : "Out of Stock"}</td>
                        `;
                    }
                    ingredientCostList.appendChild(row);
                });




                totalCostElement.textContent = `$${totalCost}`;
                recipeDetailsDiv.style.display = 'block';
            } else {
                recipeDetailsDiv.style.display = 'none';
            }
        }

        function calTotalCost(recipeCalName) {
            const recipe = recipes[recipeCalName];
            let totalCost = 0;

            const conversions = JSON.parse(localStorage.getItem('conversions')) || {};

            recipe.ingredients.forEach((ingredient, index) => {
                const inventoryItem = recipe.inventory[index];

                if (inventoryItem) {
                    const ingredientConversion = parseFloat(conversions[ingredient.unit]?.conversion || 1);
                    const inventoryConversion = parseFloat(conversions[inventoryItem.unit]?.conversion || 1);

                    const inventoryPricePerBaseUnit = inventoryItem.price / (inventoryItem.size * inventoryConversion);

                    const ingredientQuantityInBaseUnits = ingredient.quantity * ingredientConversion;

                    const ingredientCost = ingredientQuantityInBaseUnits * inventoryPricePerBaseUnit;
                    totalCost += ingredientCost;

                    // console.log(
                    //     `Ingredient: ${ingredient.ingredient}, Quantity: ${ingredient.quantity}${ingredient.unit}, Price: $${ingredientCost.toFixed(
                    //         2
                    //     )}`
                    // );
                } else {
                    console.error(`No inventory found for ingredient: ${ingredient.ingredient}`);
                }
            });

            return totalCost.toFixed(2);
        }


        ///////////////////////////////////////////////////////////////////////////////////////

        // ADD RECIPE

        // function updateUnitDropdown(ingredientDropdown, unitDropdown) {
        //     const selectedIngredient = ingredientDropdown.value;
        //     console.log('Selected ingredient:', selectedIngredient);
        //     unitDropdown.innerHTML = '<option value="">Select Units</option>'; // Reset options
        //     const 
        // }

        function addIngredient() {
            getAllUnits()
                .then(units => {
                    //console.log('Units:', units);
                    const ingredientsList = document.getElementById('ingredients-list');

                    const ingredientDiv = document.createElement('div');
                    ingredientDiv.className = 'ingredient';

                    // Create the new ingredient row
                    ingredientDiv.innerHTML = `
                        <select class="ingredientDropdown" required>
                            <option value="">Select Ingredient</option>
                        </select>
                        <input type="number" placeholder="Quantity" required min="0" class="initialQuantity">
                        <select class="unitDropdown" required>
                            <option value="">Select Units</option>
                        </select>
                        <button type="button" class="X-button" onclick="deleteIngredient(this)">X</button>
                    `;

                    ingredientsList.appendChild(ingredientDiv);

                            const newIngredientDropdown = ingredientDiv.querySelector('.ingredientDropdown');
                    const newUnitDropdown = ingredientDiv.querySelector('.unitDropdown');

                    populateAddNewDropdown(newIngredientDropdown, 'items');
                    populateAddNewDropdown(newUnitDropdown, 'conversions');

                            const newQuantityInput = ingredientDiv.querySelector('.initialQuantity');
                    newQuantityInput.addEventListener('input', () => {
                        if (newQuantityInput.value < 0) {
                            newQuantityInput.value = 0;
                        }
                    });
                })

                .catch(error => {
                    console.error('Failed to fetch units:', error);
                });
            
        }
        function deleteIngredient(button) {
            const ingredientDiv = button.parentElement;
            ingredientDiv.remove();
        }

        // Queries the database to save the new recipe
        function saveNewRecipe() {
            const recipeName = document.querySelector('.add-recipe-entry input[type="text"]').value;
            const recipeDescription = document.querySelector('.add-recipe-entry textarea').value;
            const ingredientsList = document.querySelectorAll('#ingredients-list .ingredient');

            const items = JSON.parse(localStorage.getItem('items')) || {};
            const conversions = JSON.parse(localStorage.getItem('conversions')) || {};

            const newIngredients = Array.from(ingredientsList).map(ingredientDiv => {
                const ingredientDropdown = ingredientDiv.querySelector('.ingredientDropdown');
                const ingredientName = ingredientDropdown.options[ingredientDropdown.selectedIndex].textContent;
                const quantity = parseFloat(ingredientDiv.querySelector('.initialQuantity').value);
                const unitDropdown = ingredientDiv.querySelector('.unitDropdown');
                const unit = unitDropdown.options[unitDropdown.selectedIndex].textContent;

                return {
                    ingredientName: ingredientName,
                    itemID: items[ingredientName] || null,
                    quantity: quantity,
                    unit: unit,
                    unitID: conversions[unit].unitID
                };
            });

            fetch('http://localhost:1337/api/addRecipe', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: recipeName,
                    description: recipeDescription,
                    userID: localStorage.getItem('userID'),
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.recipeID) {
                        console.log('Recipe added successfully with ID:', data.recipeID);
                        const recipeID = data.recipeID;

                        newIngredients.forEach(ingredient => {
                            if (!ingredient.itemID) {
                                console.error(`Item ID not found for ingredient: ${ingredient.ingredientName}`);
                                return;
                            }

                            fetch('http://localhost:1337/api/addRecipeItem', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    recipeID: recipeID,
                                    itemID: ingredient.itemID,
                                    quantity: ingredient.quantity,
                                    unitID: ingredient.unitID
                                })
                            })
                                .then(response => response.json())
                                .then(data => {
                                    console.log(`Ingredient ${ingredient.ingredientName} added:`, data);
                                })
                                .catch(error => {
                                    console.error('Error adding ingredient:', error);
                                });
                        });

                        const userID = localStorage.getItem('userID');
                        fetch('http://localhost:1337/api/userRecipe', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ userID })
                        })
                        .then(response => response.json())
                        .then(data => {
                            localStorage.setItem('recipes', JSON.stringify(data));
                            
                            const recipesNew = convertRecipes();
                            const recipeList = document.getElementById('recipeList');
                            recipeList.innerHTML = '';

                            for (const recipeName in recipesNew) {
                                const recipeItem = document.createElement('div');
                                recipeItem.className = 'recipe-item';
                                recipeItem.textContent = recipeName;
                                recipeItem.onclick = () => showRecipeDetailsOnHome(recipeName);
                                recipeList.appendChild(recipeItem);
                            }


                            document.getElementById('navbar').style.display = 'block';
                            showSection('home');
                            document.querySelector('.wrapper').style.display = 'none';

                        })
                        .catch(error => {
                            console.error('Error fetching recipes:', error);
                            alert('Error fetching recipes');
                        });


                        
                        
                    } else {
                        console.error('Failed to add recipe:', data.message);
                    }

                    
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }
        function getUserRecipes(userID) {
            const url = new URL('http://localhost:1337/api-v2/user/recipes');
            url.searchParams.append('userID', userID);

            return fetch(url, {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' },
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP Error: ' + response.status);
                    }
                    return response.json(); // Return the parsed JSON data
                })
                .then(data => {
                    return data; // Return the data to the caller
                })
                .catch(error => {
                    console.error('Error fetching recipes:', error);
                    alert('Error fetching recipes');
                });
        }

        ////////////////////////////////////////////////////////////////////////////////////////

        // UPDATE RECIPE

        //dropdown for recipes
        function populateDropdown() {
            getUserRecipes(localStorage.getItem('userID'))
                .then(recipes => {
                    console.log('Recipes:', recipes);
                    const dropdown = document.getElementById('chooseRecipeUpdate');
                    dropdown.innerHTML = '';
                    const uniqueRecipes = new Set();

                    recipes.forEach(recipe => {
                        const option = document.createElement('option');
                        option.value = recipe.recipeID;
                        option.textContent = recipe.recipeName;
                        dropdown.appendChild(option);  
                    })
                })
                .catch(error => {
                    console.error('Failed to fetch recipes:', error);
                });
            
            for (let recipeName in recipes) {
                if (!uniqueRecipes.has(recipeName)) {
                    uniqueRecipes.add(recipeName);
                    const option = document.createElement('option');
                    option.value = recipeName;
                    option.textContent = recipeName;
                    dropdown.appendChild(option);
                }
            }
        }
        populateDropdown();

        function getRecipe(recipeID) {
            const url = new URL('http://localhost:1337/api-v2/recipe');
            url.searchParams.append('recipeID', recipeID);

            return fetch(url, {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' },
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP Error: ' + response.status);
                    }
                    return response.json(); // Return the parsed JSON data
                })
                .then(data => {
                    return data; // Return the data to the caller
                })
                .catch(error => {
                    console.error('Error fetching recipe:', error);
                    alert('Error fetching recipe');
                });
        }

        function getRecipeItems(recipeID) {
            const url = new URL('http://localhost:1337/api-v2/recipe/items');
            url.searchParams.append('recipeID', recipeID);

            return fetch(url, {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' },
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP Error: ' + response.status);
                    }
                    return response.json(); // Return the parsed JSON data
                })
                .then(data => {
                    return data; // Return the data to the caller
                })
                .catch(error => {
                    console.error('Error fetching recipe items:', error);
                    alert('Error fetching recipe items');
                });
        }

        chooseRecipeUpdate.addEventListener('change', loadRecipeData);

        //get list of recipes to choose from
        function loadRecipeData() {
            const chosenRecipeID = Number(document.getElementById('chooseRecipeUpdate').value);
            Promise.all([getAllUnits(), getRecipeItems(chosenRecipeID), getRecipe(chosenRecipeID), getItemsWithUnits()])
                .then(([ units, recipeItems, recipe, itemsWithUnits]) => {
                    //console.log('Units by type:', unitsByType);
                    // console.log('Recipe items:', recipeItems);
                    // console.log('Recipe:', recipe);

                    document.getElementById('recipe-name').value = recipe[0]?.recipeName;
                    document.querySelector('#updateRecipeForm textarea').value = recipe[0]?.description;
                    const ingredientsList = document.getElementById('update-ingredients-list');
                    //clear out previous
                    ingredientsList.innerHTML = '';
                    recipeItems.forEach(item => {
                        const itemID = item.itemID;
                        // console.log('Item:', item);
                        const unitID = item.unitID;
                        // console.log('Unit ID:', unitID);
                        const unitType = units.units.find(unit => unit.id === unitID)?.unitType ?? "";
                        // console.log('Unit type:', unitType);
                        const validUnits = units.units.filter(unit => unit.unitType === unitType).map(unit => ({id: unit.id, name: unit.unitName}));
                        // console.log('Valid units:', validUnits);
                        const ingredientDiv = document.createElement('div');
                        ingredientDiv.className = 'ingredient-entry';
                        ingredientDiv.innerHTML = `
                            <select class="ingredient-dropdown" required>
                                ${itemsWithUnits.map(itemWithUnit => `<option value="${itemWithUnit.itemID}" data-unit-id="${itemWithUnit.unitID}">${itemWithUnit.itemName}</option>`).join('')}
                            </select>
                            
                            <input type="number" value="${item.quantity}" class="ingredient-quantity" min="0">
                            <select class="ingredient-unit">
                                ${validUnits.map(unit => `<option value="${unit.id}">${unit.name}</option>`).join('')}
                            </select>
                            <button type="button" class="X-button" onclick="deleteIngredient(this)">X</button>
                        `;

                        ingredientsList.appendChild(ingredientDiv);
                        const ingredientDropdown = ingredientDiv.querySelector('.ingredient-dropdown');
                        ingredientDropdown.value = item.itemID;

                        const unitDropdown = ingredientDiv.querySelector('.ingredient-unit');
                        ingredientDropdown.addEventListener('change', () => {
                            const selectedOption = ingredientDropdown.options[ingredientDropdown.selectedIndex];
                            // console.log('Selected option:', selectedOption);
                            // console.log('data-unit-id:', selectedOption.getAttribute('data-unit-id'));
                            const unitID2 = Number(selectedOption.getAttribute('data-unit-id'));
                            // console.log('Selected unit ID:', unitID2);
                            const unitType = units.units.find(unit => unit.id === unitID2)?.unitType ?? '';
                            // console.log('Selected unit type:', unitType);
                            unitDropdown.innerHTML = '<option value="">Select Units</option>'; // Reset options
                            const filteredUnits = units.units.filter(unit => unit.unitType === unitType);
                            filteredUnits.forEach(unit => {
                                const option = document.createElement('option');
                                option.value = unit.id;
                                option.textContent = unit.unitName;
                                unitDropdown.appendChild(option);
                            });
                        });
                        document.getElementById('updateRecipeForm').style.display = 'block';
                        document.querySelectorAll('.ingredient-quantity').forEach(input => {
                        input.addEventListener('input', () => {
                            if (input.value < 0) {
                                input.value = 0; // Reset to 0 if negative number is entered
                            }
                            });
                        });
                    });



                    // if (false) {
                    //     //const recipe = recipes[chosenRecipeID];
                    //     //localStorage.setItem('recipeID', recipe.recipeID);
                        

                        

                        

                    //     //list out the ingredients
                    //     recipe.ingredients.forEach((ingredient, index) => {
                    //         const unitID = ingredient.unitID;
                    //         //console.log('Unit ID:', unitID);
                    //         const unitType = units?.units.find(unit => unit.id === unitID)?.unitType ?? "";
                    //         //console.log('Unit type:', unitType);
                            
                    //         const validUnits = units?.units?.filter(unit => unit.unitType === unitType).map(unit => ({id: unit.id, name: unit.unitName})) ?? [];
                    //         //console.log('Valid units:', validUnits);
                    //         const ingredientDiv = document.createElement('div');
                    //         ingredientDiv.className = 'ingredient-entry';
                    //         ingredientDiv.innerHTML = `
                    //                             <input type="text" value="${ingredient.ingredient}" class="ingredient-name">
                    //                             <input type="number" value="${ingredient.quantity}" class="ingredient-quantity" min = "0">
                    //                             <select class="ingredient-unit">
                    //                                 ${validUnits.map(unit => `<option value="${unit.id}">${unit.name}</option>`).join('')}
                    //                             </select>
                    //                             <button type="button" class="X-button" onclick="deleteIngredient(this)">X</button>
                    //                         `;
                    //         ingredientsList.appendChild(ingredientDiv);
                    //     });

                    //     //Prevent users from manually entering a negative number
                    //     document.querySelectorAll('.ingredient-quantity').forEach(input => {
                    //     input.addEventListener('input', () => {
                    //         if (input.value < 0) {
                    //             input.value = 0; // Reset to 0 if negative number is entered
                    //         }
                    //         });
                    //     });

                    //     //show form to update recipe
                    //     document.getElementById('updateRecipeForm').style.display = 'block';
                    // } else {
                    //     //clear if no recipe chosen
                    //     //document.getElementById('updateRecipeForm').style.display = 'none';
                    // }
                })
                .catch(error => {
                    console.error('Failed to fetch units:', error);
                });
        }

        //add another ingredient to recipe
        function addAnotherIngredient() {
            const ingredientsList = document.getElementById('ingredient-list');

            const ingredientDiv = document.createElement('div');
            ingredientDiv.className = 'ingredient-entry';
            ingredientDiv.innerHTML = `
                <select id="ingredientDropdown" required>
                    <option value="">Select Ingredient</option>
                </select>
                <input type="number" class="ingredient-quantity" placeholder="Quantity" required min = "0">
                <select class="ingredient-unit">
                        <option value="Units">Units</option>
                        <option value="Cups">Cups</option>
                        <option value="Pounds">Pounds</option>
                        <option value="Ounces">Ounces</option>
                </select>
                <button type="button" class="X-button" onclick="deleteIngredient(this)">X</button>
                `;

                ingredientsList.appendChild(ingredientDiv);

                const quantityInput = ingredientDiv.querySelector('.ingredient-quantity');
                quantityInput.addEventListener('input', () => {
                    if (quantityInput.value < script) {
                        quantityInput.value = 0;
                    }
                });
        }

        const recipeSelector = document.getElementById('chooseRecipeUpdate');
        const recipeForm = document.getElementById('updateRecipeForm');
        const recipeNameInput = document.getElementById('recipe-name');
        const descriptionTextarea = document.getElementById('recipe-description');
        const ingredientsListDiv = document.getElementById('update-ingredients-list');
        const saveRecipeButton = document.getElementById('save-recipe-button');

        saveRecipeButton.addEventListener('click', updateRecipe);

        async function updateRecipe() {
            const recipeID = parseInt(recipeSelector.value);
            const recipeName = recipeNameInput.value;
            const description = descriptionTextarea.value;
            const ingredientElements = ingredientsListDiv.querySelectorAll('.ingredient-entry');
            const recipeItems = [];

            ingredientElements.forEach(ingredientElement => {
                const quantityInput = ingredientElement.querySelector('.ingredient-quantity');
                const itemSelect = ingredientElement.querySelector('select');
                const unitSelect = ingredientElement.querySelector('select:nth-of-type(2)');
                const quantity = parseFloat(quantityInput.value);
                const unitID = parseInt(unitSelect.value);
                const itemID = parseInt(itemSelect.value);
                if(!isNaN(quantity) && unitID && itemID) {
                    recipeItems.push({ 
                        itemID: itemID, 
                        quantity: quantity, 
                        unitID: unitID 
                    });
                }
            });

            const data = {
                recipeName: recipeName,
                description: description,
                recipeItems: recipeItems,
                userID: Number(localStorage.getItem('userID'))
            };
            try {
                const response = await fetch(`http://localhost:1337/api-v2/recipe?recipeID=${recipeID}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Failed to update recipe:', errorData);
                    alert('Failed to update recipe' + errorData.message);
                    return;
                }
                const responseData = await response.json();
                console.log('Recipe updated successfully:', responseData);
                alert('Recipe updated successfully');
            } catch (error) {
                console.error('Error updating recipe:', error);
                alert('Error updating recipe');
            }
        }
        const addIngredientButton = document.getElementById('update-add-ingredient-button');
        addIngredientButton.addEventListener('click', addUpdateRow(itemsWithUnits, units));

        function addUpdateRow(itemsWithUnits, units) {
            console.log('Adding new row');
            const ingredientsList = document.getElementById('update-ingredients-list');
            const ingredientDiv = document.createElement('div');
            ingredientDiv.className = 'ingredient-entry';
            ingredientDiv.innerHTML = `
                <select class = "ingredient-dropdown" required>
                    <option value="">Select Ingredient</option>
                    ${itemsWithUnits.map(item => `<option value="${item.itemID}" data-unit-id="${item.unitID}">${item.itemName}</option>`).join('')}
                </select>
                <input type="number" class="ingredient-quantity" placeholder="Quantity" required min = "0">
                <select class="unitDropdown" required>
                    <option value="">Select Units</option>
                </select>
                <button type="button" class="X-button" onclick="deleteIngredient(this)">X</button>
                `;
                ingredientsList.appendChild(ingredientDiv);
                const ingredientDropdown = ingredientDiv.querySelector('.ingredient-dropdown');
                const unitDropdown = ingredientDiv.querySelector('.unitDropdown');

                ingredientDropdown.addEventListener('change', () => {
                    const selectedOption = ingredientDropdown.options[ingredientDropdown.selectedIndex];
                    //console.log('Selected option:', selectedOption);
                    const unitID = Number(selectedOption.getAttribute('data-unit-id'));
                    //console.log('Selected unit ID:', unitID);
                    //console.log('units.units:', units.units);
                    const unitType = units.units.find(unit => unit.id === unitID)?.unitType ?? '';
                    //console.log('Selected unit type:', unitType);

                    unitDropdown.innerHTML = '<option value="">Select Units</option>'; // Reset options
                    const filteredUnits = units.units.filter(unit => unit.unitType === unitType);
                    filteredUnits.forEach(unit => {
                        const option = document.createElement('option');
                        option.value = unit.unitID;
                        option.textContent = unit.unitName;
                        unitDropdown.appendChild(option);
                    });
                });             
        }
        
        ////////////////////////////////////////////////////////////////////////////////////////

        //shows dropdown for the recipes to select from to show cost
        function populateRecipeCostDropdown() {
            const dropdown = document.getElementById('chooseRecipeCost');
            dropdown.innerHTML = '<option value="">Select a recipe</option>'; //to reset

            for (const recipeName in recipes) {
                const option = document.createElement('option');
                option.value = recipeName;
                option.textContent = recipeName;
                dropdown.appendChild(option);
            }
        }
        populateRecipeCostDropdown();

        //show recipe cost details
        function viewRecipeCost() {
            const chosenRecipeName = document.getElementById('chooseRecipeCost').value;
            const recipeDetailsDiv = document.getElementById('recipeCostDetails');
            const ingredientCostList = document.getElementById('ingredientCostList');
            const totalCostElement = document.getElementById('totalCost');

            if (chosenRecipeName && recipes[chosenRecipeName]) {
                const recipe = recipes[chosenRecipeName];
                document.getElementById('chosenRecipeName').textContent = recipe.name;

                const recipeDescription = document.getElementById('recipeDescriptionCostBox');
                recipeDescription.value = recipe.description;
                ingredientCostList.innerHTML = '';
                let totalCost = 0;  //to start with then add the costs
                

                //show the list of recipe details with cost
                recipe.ingredients.forEach((ingredient) => {
                    const row = document.createElement('tr');

                    row.innerHTML = `
                                    <td>${ingredient.ingredient}</td>
                                    <td>${ingredient.quantity}</td>
                                    <td>${ingredient.unit}</td>
                                    <td>$${(ingredient.price * ingredient.quantity).toFixed(2)}</td>
                                    <td>${ingredient.available ? "In Stock" : "Out of Stock"}</td>
                                `;

                    ingredientCostList.appendChild(row);
                    totalCost += ingredient.price * ingredient.quantity;
                });

                totalCostElement.textContent = `$${totalCost.toFixed(2)}`;
                recipeDetailsDiv.style.display = 'block';
            } else {
                recipeDetailsDiv.style.display = 'none';
                alert('Select a recipe.');
            }
        }
    

    </script>
</body>
</html>