<!DOCTYPE html>
<html lang="en">
<head>
    <title>Recipe Budgeter</title>
    <link rel="stylesheet" href="style.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css'
          rel='stylesheet'>
</head>
<body>
    <div class="wrapper">
        <h1 class="Title">Recipe Budgeter</h1>
        <form id="loginForm">
            <h1>Login</h1>
            <div class="input-box">
                <input type="text" id="username" placeholder="Username/Email"
                       required>
                <i class='bx bxs-user'></i>
            </div>

            <div class="input-box">
                <input type="password" id="password"
                       placeholder="Password" required>
                <i class='bx bxs-lock-alt'></i>
            </div>

            <button type="submit" class="login-button">Login</button>

            <div class="register">
                <a href="#" onclick="showSignup()">Create Account</a>
            </div>
        </form>
    </div>

    <div class="wrapper" id="signupWrapper" style="display: none;"> 
        <form id="signupForm">
            <h1 class="Title">Recipe Budgeter</h1>
            <h1 class="Subtitle">Sign Up</h1>

            <div class="input-box">
                <input type="text" id="name" placeholder="Name" required>
                <i class='bx bxs-envelope'></i>
            </div>  

            <div class="input-box">
                <input type="text" id="newUsername" placeholder="Username" required>
                <i class='bx bxs-user'></i>
            </div> 

            <div class="input-box">
                <input type="password" id="newPassword" placeholder="Password" required>
                <i class="bx bxs-lock-alt"></i>
            </div>

            <div class="input-box">
                <input type="password" id="confirmpassword" placeholder="Confirm Password" required>
                <i class='bx bxs-lock-alt'></i>
            </div>     
            
            <button type="submit" class="login-button">Sign Up</button>

            <div class="register">
                <a href="#" onclick="showLogin()">Already have an account? Login</a>
            </div>    
        </form>
    </div>

    <!-- navigation bar -->
    <nav class="navbar" id="navbar" style="display: none;">
        <ul>
            <li><a href="#home">Home</a></li>
            <li><a href="#add-recipe">Add A New Recipe</a></li>
            <li><a href="#view-recipes">Update A Recipe</a></li>
            <li><a href="#" onclick="showLogin()">Logout</a></li>
        </ul>
    </nav>

    <!------------------------------------------------------------------------------------------->
    <!-- for home page -->
    <div class="section" id="home" style="display: none;">
        <h2>Welcome to Recipe Budgeter</h2>
        <h1>Here are your recipes!</h1>
        <h3 style="text-align: center;">Click on a recipe to view details</h3>

        <!--recipe list-->
        <div id="recipeList">
            <!-- Populated with JS -->
        </div>


        <!--recipe cost details for home page -->
        <div id="recipeCostDetailsHome" style="display: none;">
            <h4 id="chosenRecipeNameHome"></h4>
            <div class="description-box">
                <textarea readonly id="recipeDescriptionBox" placeholder="Recipe Description" required></textarea>
            </div> 
            <table>
                <thead>
                    <tr>
                        <th>Ingredient</th>
                        <th>Quantity</th>
                        <th>Unit</th>
                        <th>Price</th>
                        <th>Availability</th>
                    </tr>
                </thead>
                <tbody id="ingredientCostListHome">

                </tbody>
            </table>
            <h5>Total Cost: <span id="totalCostHome"></span></h5>
        </div>

    </div>

    <!------------------------------------------------------------------------------------------->
    <!-- for add new recipe page -->
    <div class="section" id="add-recipe" style="display: none;">
        <h2>Add Your Recipe</h2>
        <h3 style="text-align: center;">Add your own recipe</h3>
        <form action="" class="add-recipe-entry">
            <div class="input-box">
                <input type="text" placeholder="Recipe Name" required>
            </div>
            <div class="description-box">
                <textarea placeholder="Recipe Description" required></textarea>
            </div>    
            <div class="ingredients-list" id="ingredients-list">
                <div class="ingredient">
                    <select class="ingredientDropdown" required>
                        <option value="">Select Ingredient</option>
                    </select>
                    <input type="number" placeholder="Quantity" required min="0" class="initialQuantity">
                    <select class="unitDropdown" required>
                        <option value="">Select Units</option>
                    </select>
                    <button type="button" class="X-button" onclick="deleteIngredient(this)">X</button>
                </div>                
            </div>

            <button type="button" onclick="addIngredient()">Add Another Ingredient</button>
            <button type="button" onclick="saveNewRecipe()">Save Recipe</button>
        </form>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const quantityInputs = document.querySelectorAll('.initialQuantity');
            quantityInputs.forEach(input => {
                input.addEventListener('input', () => {
                    if (input.value < 0) {
                        input.value = 0;
                    }
                });
            });
        });

        function populateAddItemDropdown() {
            const items = JSON.parse(localStorage.getItem('items')) || {};
            const dropdowns = document.querySelectorAll('.ingredientDropdown');

            dropdowns.forEach(dropdown => {
                dropdown.innerHTML = '<option value="">Select Ingredient</option>';

                for (const [name, id] of Object.entries(items)) {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = name;
                    dropdown.appendChild(option);
                }
            });
        }

        function populateAddUnitDropdown() {
            const conversions = JSON.parse(localStorage.getItem('conversions')) || {};
            const dropdowns = document.querySelectorAll('.unitDropdown');

            dropdowns.forEach(dropdown => {
                dropdown.innerHTML = '<option value="">Select Units</option>';

                for (const unitName of Object.keys(conversions)) {
                    const option = document.createElement('option');
                    option.value = unitName;
                    option.textContent = unitName;
                    dropdown.appendChild(option);
                }
            });
        }

        function populateAddNewDropdown(dropdown, storageKey) {
            const data = JSON.parse(localStorage.getItem(storageKey)) || {};
            const dropdowns = dropdown instanceof NodeList || Array.isArray(dropdown) ? dropdown : [dropdown];

            dropdowns.forEach(dd => {
                dd.innerHTML = '<option value="">Select ' + (storageKey === 'items' ? 'Ingredient' : 'Units') + '</option>';

                for (const [name, value] of Object.entries(data)) {
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = name;
                    dd.appendChild(option);
                }
            });
        }

        populateAddItemDropdown();
        populateAddUnitDropdown();
    </script>

    <!------------------------------------------------------------------------------------------->
    <!-- for update a recipe page -->

    <div class="section" id="view-recipes" style="display: none;">
        <h2>List of Recipes</h2>
        <h3 style="text-align: center;">Select a recipe</h3>
        <!-- select recipe -->
        <select id="chooseRecipeUpdate" onchange="loadRecipeData()">
            <option value="">Select a recipe</option>
        </select>

        <!-- to allow update recipe -->
        <form id="updateRecipeForm" style="display: none;">
            <h1>
                <input type="text" id="recipeName" required>
            </h1>
            
            <div class="description-box">
                <textarea placeholder="Recipe Description" required></textarea>
            </div>  
            <div class="ingredients-list" id="ingredient-list">
                <div class="ingredient">
                    <input type="number" placeholder="Quantity" required min = "0">
                    <select>
                        <option value="Units">Units</option>
                        <option value="Cups">Cups</option>
                        <option value="Pounds">Pounds</option>
                        <option value="Ounces">Ounces</option>
                    </select>
                    <button  type="button" class="X-button" onclick="deleteIngredient(this)">X</button>
                </div>
            </div>

            <button type="button" onclick="addAnotherIngredient()">Add Another Ingredient</button>
            <button type="button" onclick="updateRecipe()">Save Recipe</button>
            <button type="button" onclick="deleteRecipe()">Delete Recipe</button>
        </form>
    </div>

    <!------------------------------------------------------------------------------------------->
    <!-- Scripts -->

    <script src="js/login.js"></script>
    <script src="js/home.js"></script>
    <script src="js/updateRecipe.js"></script>
    <script>

        function showLogin() {
            document.getElementById('signupWrapper').style.display = 'none';
            document.querySelector('.wrapper').style.display = 'block';
            document.getElementById('navbar').style.display = 'none';
               document.getElementById('username').value = '';
    document.getElementById('password').value = '';
        }

        function showSignup() {
            document.querySelector('.wrapper').style.display = 'none';
            document.getElementById('signupWrapper').style.display = 'block';
        }

        //hide other pages when switching through pages on nav bar
        function showSection(sectionId) {
            const sections = document.querySelectorAll('.section');

            sections.forEach(section => {
                section.style.display = 'none';
            });

            document.getElementById(sectionId).style.display = 'block';
        }

        ////////////////////////////////////////////////////////////////////////////////////////

        let recipes = convertRecipes();

        document.querySelectorAll('.navbar a').forEach(link => {
            link.addEventListener('click', function (event) {
                event.preventDefault();
                const targetSection = this.getAttribute('href').substring(1);
                showSection(targetSection);
            });
        });

        ////////////////////////////////////////////////////////////////////////////////////////

        // HOME PAGE SCRIPTS

        //list of clickable recipes on the home page
        function populateRecipeList() {
            const recipeList = document.getElementById('recipeList');
            
            recipeList.innerHTML = '';

            for (const recipeName in recipes) {
                const recipeItem = document.createElement('div');
                recipeItem.className = 'recipe-item';
                recipeItem.textContent = recipeName;
                recipeItem.onclick = () => showRecipeDetailsOnHome(recipeName);
                recipeList.appendChild(recipeItem);
                
            }
        }
        populateRecipeList();

        // clickable and populates table with recipe details
        function showRecipeDetailsOnHome(chosenRecipeName) {
            const recipeDetailsDiv = document.getElementById('recipeCostDetailsHome');
            const ingredientCostList = document.getElementById('ingredientCostListHome');
            const totalCostElement = document.getElementById('totalCostHome');

            if (chosenRecipeName && recipes[chosenRecipeName]) {
                const recipe = recipes[chosenRecipeName];
                document.getElementById('chosenRecipeNameHome').textContent = recipe.name;
                const recipeDescription = document.getElementById('recipeDescriptionBox');

                ingredientCostList.innerHTML = '';
                recipeDescription.value = recipe.description;

                let totalCost = 0;


                recipe.ingredients.forEach((ingredient, index) => {
                    const inventoryItem = recipe.inventory[index];

                    const row = document.createElement('tr');
                    if (inventoryItem) {
                        const pricePerUnit = parseFloat(inventoryItem.price);
                        const size = parseFloat(inventoryItem.size);
                        const pricePerSize = (pricePerUnit / size).toFixed(2);

                        row.innerHTML = `
                            <td>${ingredient.ingredient}</td>
                            <td>${ingredient.quantity}</td>
                            <td>${ingredient.unit}</td>
                            <td>$${pricePerSize} / ${inventoryItem.unit}</td>
                            <td>${ingredient.available ? "In Stock" : "Out of Stock"}</td>
                        `;
                        
                        totalCost = calTotalCost(chosenRecipeName);
                    } else {
                        row.innerHTML = `
                            <td>${ingredient.ingredient}</td>
                            <td>${ingredient.quantity}</td>
                            <td>${ingredient.unit}</td>
                            <td>Price Not Found</td>
                            <td>${ingredient.available ? "In Stock" : "Out of Stock"}</td>
                        `;
                    }
                    ingredientCostList.appendChild(row);
                });




                totalCostElement.textContent = `$${totalCost}`;
                recipeDetailsDiv.style.display = 'block';
            } else {
                recipeDetailsDiv.style.display = 'none';
            }
        }

        function calTotalCost(recipeCalName) {
            const recipe = recipes[recipeCalName];
            let totalCost = 0;

            const conversions = JSON.parse(localStorage.getItem('conversions')) || {};

            recipe.ingredients.forEach((ingredient, index) => {
                const inventoryItem = recipe.inventory[index];

                if (inventoryItem) {
                    const ingredientConversion = parseFloat(conversions[ingredient.unit]?.conversion || 1);
                    const inventoryConversion = parseFloat(conversions[inventoryItem.unit]?.conversion || 1);

                    const inventoryPricePerBaseUnit = inventoryItem.price / (inventoryItem.size * inventoryConversion);

                    const ingredientQuantityInBaseUnits = ingredient.quantity * ingredientConversion;

                    const ingredientCost = ingredientQuantityInBaseUnits * inventoryPricePerBaseUnit;
                    totalCost += ingredientCost;

                    // console.log(
                    //     `Ingredient: ${ingredient.ingredient}, Quantity: ${ingredient.quantity}${ingredient.unit}, Price: $${ingredientCost.toFixed(
                    //         2
                    //     )}`
                    // );
                } else {
                    console.error(`No inventory found for ingredient: ${ingredient.ingredient}`);
                }
            });

            return totalCost.toFixed(2);
        }


        ///////////////////////////////////////////////////////////////////////////////////////

        // ADD RECIPE

        function addIngredient() {
            const ingredientsList = document.getElementById('ingredients-list');

            const ingredientDiv = document.createElement('div');
            ingredientDiv.className = 'ingredient';

            // Create the new ingredient row
            ingredientDiv.innerHTML = `
                <select class="ingredientDropdown" required>
                    <option value="">Select Ingredient</option>
                </select>
                <input type="number" placeholder="Quantity" required min="0" class="initialQuantity">
                <select class="unitDropdown" required>
                    <option value="">Select Units</option>
                </select>
                <button type="button" class="X-button" onclick="deleteIngredient(this)">X</button>
            `;

            ingredientsList.appendChild(ingredientDiv);

            const newIngredientDropdown = ingredientDiv.querySelector('.ingredientDropdown');
            const newUnitDropdown = ingredientDiv.querySelector('.unitDropdown');

            populateAddNewDropdown(newIngredientDropdown, 'items');
            populateAddNewDropdown(newUnitDropdown, 'conversions');

            const newQuantityInput = ingredientDiv.querySelector('.initialQuantity');
            newQuantityInput.addEventListener('input', () => {
                if (newQuantityInput.value < 0) {
                    newQuantityInput.value = 0;
                }
            });
        }
        function deleteIngredient(button) {
            const ingredientDiv = button.parentElement;
            ingredientDiv.remove();
        }

        // Queries the database to save the new recipe
        function saveNewRecipe() {
            const recipeName = document.querySelector('.add-recipe-entry input[type="text"]').value;
            const recipeDescription = document.querySelector('.add-recipe-entry textarea').value;
            const ingredientsList = document.querySelectorAll('#ingredients-list .ingredient');

            const items = JSON.parse(localStorage.getItem('items')) || {};
            const conversions = JSON.parse(localStorage.getItem('conversions')) || {};

            const newIngredients = Array.from(ingredientsList).map(ingredientDiv => {
                const ingredientDropdown = ingredientDiv.querySelector('.ingredientDropdown');
                const ingredientName = ingredientDropdown.options[ingredientDropdown.selectedIndex].textContent;
                const quantity = parseFloat(ingredientDiv.querySelector('.initialQuantity').value);
                const unitDropdown = ingredientDiv.querySelector('.unitDropdown');
                const unit = unitDropdown.options[unitDropdown.selectedIndex].textContent;

                return {
                    ingredientName: ingredientName,
                    itemID: items[ingredientName] || null,
                    quantity: quantity,
                    unit: unit,
                    unitID: conversions[unit].unitID
                };
            });

            fetch('http://localhost:1337/api/addRecipe', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: recipeName,
                    description: recipeDescription,
                    userID: localStorage.getItem('userID'),
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.recipeID) {
                        console.log('Recipe added successfully with ID:', data.recipeID);
                        const recipeID = data.recipeID;

                        newIngredients.forEach(ingredient => {
                            if (!ingredient.itemID) {
                                console.error(`Item ID not found for ingredient: ${ingredient.ingredientName}`);
                                return;
                            }

                            fetch('http://localhost:1337/api/addRecipeItem', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    recipeID: recipeID,
                                    itemID: ingredient.itemID,
                                    quantity: ingredient.quantity,
                                    unitID: ingredient.unitID
                                })
                            })
                                .then(response => response.json())
                                .then(data => {
                                    console.log(`Ingredient ${ingredient.ingredientName} added:`, data);
                                })
                                .catch(error => {
                                    console.error('Error adding ingredient:', error);
                                });
                        });

                        const userID = localStorage.getItem('userID');
                        fetch('http://localhost:1337/api/userRecipe', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ userID })
                        })
                        .then(response => response.json())
                        .then(data => {
                            localStorage.setItem('recipes', JSON.stringify(data));
                            
                            const recipesNew = convertRecipes();
                            const recipeList = document.getElementById('recipeList');
                            recipeList.innerHTML = '';

                            for (const recipeName in recipesNew) {
                                const recipeItem = document.createElement('div');
                                recipeItem.className = 'recipe-item';
                                recipeItem.textContent = recipeName;
                                recipeItem.onclick = () => showRecipeDetailsOnHome(recipeName);
                                recipeList.appendChild(recipeItem);
                            }


                            document.getElementById('navbar').style.display = 'block';
                            showSection('home');
                            document.querySelector('.wrapper').style.display = 'none';

                        })
                        .catch(error => {
                            console.error('Error fetching recipes:', error);
                            alert('Error fetching recipes');
                        });


                        
                        
                    } else {
                        console.error('Failed to add recipe:', data.message);
                    }

                    
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        ////////////////////////////////////////////////////////////////////////////////////////

        // UPDATE RECIPE

        //dropdown for recipes
        function populateDropdown() {
            const dropdown = document.getElementById('chooseRecipeUpdate');
            dropdown.innerHTML = '';
            const uniqueRecipes = new Set();

            for (let recipeName in recipes) {
                if (!uniqueRecipes.has(recipeName)) {
                    uniqueRecipes.add(recipeName);
                    const option = document.createElement('option');
                    option.value = recipeName;
                    option.textContent = recipeName;
                    dropdown.appendChild(option);
                }
            }
        }
        populateDropdown();

        //get list of recipes to choose from
        function loadRecipeData() {
            const chosenRecipeName = document.getElementById('chooseRecipeUpdate').value;
            if (chosenRecipeName) {
                const recipe = recipes[chosenRecipeName];
                localStorage.setItem('recipeID', recipe.recipeID);
                document.getElementById('recipeName').value = recipe.name;

                document.querySelector('#updateRecipeForm textarea').value = recipe.description;

                const ingredientsList = document.getElementById('ingredient-list');
                ingredientsList.innerHTML = '';

                //list out the ingredients
                recipe.ingredients.forEach((ingredient, index) => {
                    const ingredientDiv = document.createElement('div');
                    ingredientDiv.className = 'ingredient-entry';
                    ingredientDiv.innerHTML = `
                                        <input type="text" value="${ingredient.ingredient}" class="ingredient-name">
                                        <input type="number" value="${ingredient.quantity}" class="ingredient-quantity" min = "0">
                                        <input type="text" value="${ingredient.unit}" class="ingredient-unit">
                                        <button type="button" class="X-button" onclick="deleteIngredient(this)">X</button>
                                    `;
                    ingredientsList.appendChild(ingredientDiv);
                });

                document.querySelectorAll('.ingredient-quantity').forEach(input => {
                input.addEventListener('input', () => {
                    if (input.value < 0) {
                        input.value = 0;
                    }
                    });
                });

                document.getElementById('updateRecipeForm').style.display = 'block';
            } else {
                document.getElementById('updateRecipeForm').style.display = 'none';
            }
        }

        //add another ingredient to recipe
        function addAnotherIngredient() {
            const ingredientsList = document.getElementById('ingredient-list');

            const ingredientDiv = document.createElement('div');
            ingredientDiv.className = 'ingredient-entry';
            ingredientDiv.innerHTML = `
                <select id="ingredientDropdown" required>
                    <option value="">Select Ingredient</option>
                </select>
                <input type="number" class="ingredient-quantity" placeholder="Quantity" required min = "0">
                <select class="ingredient-unit">
                        <option value="Units">Units</option>
                        <option value="Cups">Cups</option>
                        <option value="Pounds">Pounds</option>
                        <option value="Ounces">Ounces</option>
                </select>
                <button type="button" class="X-button" onclick="deleteIngredient(this)">X</button>
                `;

                ingredientsList.appendChild(ingredientDiv);

                const quantityInput = ingredientDiv.querySelector('.ingredient-quantity');
                quantityInput.addEventListener('input', () => {
                    if (quantityInput.value < script) {
                        quantityInput.value = 0;
                    }
                });
        
        ////////////////////////////////////////////////////////////////////////////////////////

    } 

    </script>
</body>
</html>